# ─── Definição dos upstreams ────────────────────────────────────────────────────

# Chat Microservice
upstream chat_service {
    server chat_microservice_webserver:80;
}

# Event Microservice
upstream event_service {
    server event_manager_webserver:80;
}

# Notification Microservice
upstream noti_service {
    server noti_microservice_webserver:80;
}

# Laravel principal (utilizadores, autenticação, etc)
upstream laravel_service {
    server laravel-nginx:80;
}

# Rating Microservice
upstream rating_service {
    server rate_microservice_webserver:80;
}

# Achievements Microservice
upstream achievements_service {
    server ach_microservice_webserver:80;
}


# ─── Configuração do servidor ──────────────────────────────────────────────────

server {
    listen 80;
    server_name localhost;

    # ── Chat Service (/api/sendMessage e /api/fetchMessages) ──
    location ~ ^/api/(sendMessage|fetchMessages)/ {
        # Envia tudo para o chat_service, mantendo /api/... na frente
        proxy_pass http://chat_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Event Service ────────────────────────────────────────────────
    # Estatísticas (/api/stats)
    location = /api/stats {
        proxy_pass http://event_service/api/stats;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    # Rotas de eventos (/api/events/...)
    location ^~ /api/events {
        proxy_pass http://event_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Notifications Service (/api/notifications/...) ───────────────
    location ^~ /api/notifications {
        proxy_pass http://noti_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

     #── Users / Auth Service (/api/users/...) ────────────────────────
    location ^~ /api/users {
        # se o teu Laravel principal esperava /api/users/...
        proxy_pass http://laravel_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Users / Auth Service
location ^~ /api/auth {
    proxy_pass http://laravel_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}


    # ── Rating Service (/api/rating/...) ──────────────────────────────
    location ^~ /api/rating {
        proxy_pass http://rating_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Achievements Service (/api/achievements/...) ──────────────────
    location ^~ /api/achievements {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # XP & Level (Achievements MS)
location ^~ /api/profile {
    proxy_pass http://achievements_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

   
    # Sports (Laravel principal)
location ^~ /api/sports {
    proxy_pass http://event_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

location ^~ /api/password {
    proxy_pass http://laravel_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

}

