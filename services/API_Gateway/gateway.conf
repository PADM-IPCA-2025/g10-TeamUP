# ─── Definição dos upstreams ────────────────────────────────────────────────────

# Chat Microservice
upstream chat_service {
    server chat_microservice_webserver:80;
}

# Event Microservice
upstream event_service {
    server event_manager_webserver:80;
}

# Notification Microservice
upstream noti_service {
    server noti_microservice_webserver:80;
}

# Laravel principal (utilizadores, autenticação, etc)
upstream laravel_service {
    server laravel-nginx:80;
}

# Rating Microservice
upstream rating_service {
    server rate_microservice_webserver:80;
}

# Achievements Microservice
upstream achievements_service {
    server ach_microservice_webserver:80;
}


# ─── Configuração do servidor ──────────────────────────────────────────────────

server {
    listen 80 default_server;
    server_name localhost;

    # ── Chat Service (/api/sendMessage e /api/fetchMessages) ──
    location ~ ^/api/(sendMessage|fetchMessages)/ {
        proxy_pass http://chat_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Event Service ────────────────────────────────────────────────
    # Estatísticas (/api/stats)
    location = /api/stats {
        proxy_pass http://event_service/api/stats;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Rating feedback (must come before the generic /api/events) ──
    location ~ ^/api/events/\d+/feedback$ {
        proxy_pass http://rating_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Rotas de eventos (/api/events/...) ─────────────────────────
    location ^~ /api/events {
        proxy_pass http://event_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    #
    # ── EVERYTHING BELOW HERE IS ORDER-SENSITIVE ──────────────────
    #

    # ── (1) First: “/api/users/<number>/events” must go to Event Microservice ──
    # 
    # Any call matching /api/users/123/events (or /api/users/456/events?foo=bar, etc.)
    # will be proxied to the Event Microservice:
    #
    location ~ ^/api/users/\d+/events {
        proxy_pass http://event_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── (2) Next: all other /api/users/... should go into Laravel
    #
    # We deliberately do NOT use “^~” here, so that regex matches (above) take priority.
    #
    location /api/users {
        proxy_pass http://laravel_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Auth Service (/api/auth/...) ─────────────────────────────────
    location ^~ /api/auth {
        proxy_pass http://laravel_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Notifications Service (/api/notifications/...) ───────────────
    location ^~ /api/notifications {
        proxy_pass http://noti_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Rating Service (/api/rating/...) ──────────────────────────────
    location ^~ /api/rating {
        proxy_pass http://rating_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Achievements Service (/api/achievements/...) ──────────────────
    location ^~ /api/achievements {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── XP & Level (Achievements MS) (/api/profile/...) ───────────────
    location ^~ /api/profile {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Sports (Event MS) (/api/sports/...) ───────────────────────────
    location ^~ /api/sports {
        proxy_pass http://event_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Password‐related (/api/password/...) ───────────────────────────
    location ^~ /api/password {
        proxy_pass http://laravel_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── User‐average rating (/api/userAverage) ────────────────────────
    location ^~ /api/userAverage {
        proxy_pass http://rating_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── (STATIC) Serve actual .png/.jpg/etc under /achievements/… ───────
    location ^~ /achievements/ {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
