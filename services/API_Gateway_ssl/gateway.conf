# ─── Definição dos upstreams ────────────────────────────────────────────────────

# Chat Microservice
upstream chat_service {
    server chat_microservice_webserver:80;
}

# Event Microservice
upstream event_service {
    server event_manager_webserver:80;
}

# Laravel principal (utilizadores, autenticação, etc)
upstream laravel_service {
    server laravel-nginx:80;
}

# Rating Microservice
upstream rating_service {
    server rate_microservice_webserver:80;
}

# Achievements Microservice
upstream achievements_service {
    server ach_microservice_webserver:80;
}


# ─── Configuração do servidor ──────────────────────────────────────────────────
# 1) HTTP → redireciona para HTTPS na porta 8443
server {
    listen 80;
    server_name localhost;
    return 301 https://$host:8443$request_uri;
}

# 2) HTTPS a servir todo o teu proxy
server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # ── Chat Service (/api/sendMessage and /api/fetchMessages) ──
    location ~ ^/api/(sendMessage|fetchMessages)/ {
        proxy_pass http://chat_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Event stats (/api/stats) ──
    location = /api/stats {
        proxy_pass http://event_service/api/stats;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Rating‐feedback (must match FIRST) ──
    location ~ ^/api/events/\d+/feedback$ {
        proxy_pass http://rating_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── “Any other /api/events…” (no ^~) ──
    location /api/events {
        proxy_pass http://event_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── (1) /api/users/{id}/events → Event Microservice ──
    location ~ ^/api/users/\d+/events {
        proxy_pass http://event_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── (2) /api/users/... → Laravel ──
    location /api/users {
        proxy_pass http://laravel_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Auth (/api/auth/…) ──
    location ^~ /api/auth {
        proxy_pass http://laravel_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Rating Service (/api/rating/…) ──
    location ^~ /api/rating {
        proxy_pass http://rating_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Leaderboard (/api/leaderboard) ──
    location = /api/leaderboard {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Achievements Service (/api/achievements/…) ──
    location ^~ /api/achievements {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── XP & Level (/api/profile/…) ──
    location ^~ /api/profile {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Sports (/api/sports/…) ──
    location ^~ /api/sports {
        proxy_pass http://event_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Password (/api/password/…) ──
    location ^~ /api/password {
        proxy_pass http://laravel_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── User‐average (/api/userAverage) ──
    location ^~ /api/userAverage {
        proxy_pass http://rating_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Static assets under /achievements/… ──
    location ^~ /achievements/ {
        proxy_pass http://achievements_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
